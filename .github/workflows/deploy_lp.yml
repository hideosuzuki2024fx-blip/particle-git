name: Deploy LP

on:
  push:
    branches: [ "main" ]
    paths:
      - "ops/ai_policy.md"
      - ".github/workflows/deploy_lp.yml"
      - "README.md"
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Generate HTML from Markdown
        run: |
          set -e
          mkdir -p public

          # ops/ai_policy.md -> public/ops/ai_policy.html
          if [ -f ops/ai_policy.md ]; then
            SRC="ops/ai_policy.md"
            OUT="public/ops/ai_policy.html"
            mkdir -p "$(dirname "$OUT")"
            pandoc "$SRC" -s -o "$OUT" --metadata title="AI Policy"
          fi

          # index.html の元になる Markdown を決定
          if [ -f docs/product/LP_EmotionCut.md ]; then
            INDEX_SRC="docs/product/LP_EmotionCut.md"
          elif [ -f README.md ]; then
            INDEX_SRC="README.md"
          elif [ -f START_HERE.md ]; then
            INDEX_SRC="START_HERE.md"
          fi

          # index.html を生成 (fallback 付き)
          if [ -n "${INDEX_SRC:-}" ]; then
            pandoc "$INDEX_SRC" -s -o public/index.html --metadata title="ai_dev_core"
          else
            printf "%s" "<!doctype html><meta charset='utf-8'><title>ai_dev_core</title><h1>ai_dev_core</h1><p>No markdown found.</p>" > public/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
